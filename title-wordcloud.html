<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans+TC:wght@400;500;700&family=Plus+Jakarta+Sans:wght@400;500;700;800" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <title>影片標題文字雲分析 - YouTube 趨勢追蹤分析平台</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
            --primary-color: #ea2a33;
        }
        body {
            font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .word-cloud {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 2rem;
            min-height: 400px;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-radius: 1rem;
            border: 1px solid #374151;
        }
        .word-item {
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 6px;
            user-select: none;
        }
        .word-item:hover {
            transform: scale(1.1);
            text-shadow: 0 0 10px currentColor;
            background: rgba(234, 42, 51, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
        <div class="flex h-full grow flex-col">
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-800 px-10 py-4">
                <div class="flex items-center gap-4 text-white">
                    <a href="index.html" class="flex items-center gap-4 text-white hover:text-gray-300 transition-colors">
                        <svg class="h-8 w-8 text-[var(--primary-color)]" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 15.65v-7.3L16.03 12M22 12c0 5.52-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2s10 4.48 10 10zM4 12c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8-8 3.58-8 8z"></path>
                        </svg>
                        <h1 class="text-xl font-bold tracking-tight">影片標題文字雲分析</h1>
                    </a>
                </div>

                <div class="flex items-center gap-6">
                    <!-- 導航按鈕 -->
                    <div class="flex items-center gap-2">
                        <a href="video-search.html" class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium hover:bg-gray-600 hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-sm mr-1">video_library</span>
                            影片搜尋
                        </a>
                        <a href="hashtag-analytics.html" class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium hover:bg-gray-600 hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-sm mr-1">analytics</span>
                            Hashtag 統計
                        </a>
                        <a href="title-wordcloud.html" class="px-4 py-2 rounded-lg bg-[var(--primary-color)] text-white font-medium hover:bg-red-700 transition-colors">
                            <span class="material-symbols-outlined text-sm mr-1">cloud</span>
                            標題文字雲
                        </a>
                    </div>

                    <!-- 資料狀態和操作 -->
                    <div class="flex items-center gap-4">
                        <span id="dataCount" class="text-sm text-gray-400">載入中...</span>
                        <button id="refreshBtn" class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-full bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white">
                            <span class="material-symbols-outlined">refresh</span>
                        </button>
                    </div>
                </div>
            </header>

            <main class="flex-1 px-4 py-8 sm:px-6 lg:px-8">
                <div class="mx-auto max-w-7xl">
                    <!-- 控制面板 -->
                    <div class="mb-8 rounded-lg bg-gray-800/50 p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold tracking-tight text-white">文字雲設定</h2>
                            <div class="flex items-center gap-4">
                                <select id="sortBy" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="frequency">按詞頻排序</option>
                                    <option value="views">按觀看數排序</option>
                                </select>
                                <select id="maxWords" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="50">顯示前 50 個詞</option>
                                    <option value="100">顯示前 100 個詞</option>
                                    <option value="200">顯示前 200 個詞</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
                            <div class="flex flex-col">
                                <label class="mb-2 text-sm font-medium text-gray-300">最小字數</label>
                                <select id="minWordLength" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="1">1 字以上</option>
                                    <option value="2" selected>2 字以上</option>
                                    <option value="3">3 字以上</option>
                                    <option value="4">4 字以上</option>
                                </select>
                            </div>

                            <div class="flex flex-col">
                                <label class="mb-2 text-sm font-medium text-gray-300">時間範圍</label>
                                <select id="timeRange" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="all">全部時間</option>
                                    <option value="7">最近 7 天</option>
                                    <option value="30">最近 30 天</option>
                                    <option value="90">最近 90 天</option>
                                </select>
                            </div>

                            <div class="flex flex-col">
                                <label class="mb-2 text-sm font-medium text-gray-300">地區篩選</label>
                                <select id="regionFilter" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="">全部地區</option>
                                </select>
                            </div>

                            <div class="flex flex-col">
                                <label class="mb-2 text-sm font-medium text-gray-300">影片類型</label>
                                <select id="typeFilter" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="">全部類型</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 載入指示器 -->
                    <div id="loadingIndicator" class="flex items-center justify-center py-12">
                        <span class="material-symbols-outlined text-4xl text-gray-400 loading">cloud</span>
                        <span class="ml-2 text-gray-400">生成文字雲中...</span>
                    </div>

                    <!-- 統計概要 -->
                    <div id="statsSection" class="mb-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4" style="display: none;">
                        <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">總關鍵詞數</p>
                                    <p id="totalWords" class="text-2xl font-bold text-white">0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">text_fields</span>
                            </div>
                        </div>

                        <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">總詞頻</p>
                                    <p id="totalFrequency" class="text-2xl font-bold text-white">0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">trending_up</span>
                            </div>
                        </div>

                        <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">總觀看數</p>
                                    <p id="totalViews" class="text-2xl font-bold text-white">0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">visibility</span>
                            </div>
                        </div>

                        <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">平均詞頻</p>
                                    <p id="avgFrequency" class="text-2xl font-bold text-white">0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">calculate</span>
                            </div>
                        </div>
                    </div>

                    <!-- 文字雲區域 -->
                    <div id="wordCloudSection" class="grid grid-cols-1 lg:grid-cols-3 gap-8" style="display: none;">
                        <!-- 主要文字雲 -->
                        <div class="lg:col-span-2">
                            <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                                <h3 class="text-xl font-bold text-white mb-6">標題關鍵詞文字雲</h3>
                                <div id="wordCloud" class="word-cloud">
                                    <!-- 動態生成的文字雲 -->
                                </div>
                            </div>
                        </div>

                        <!-- 側邊列表 -->
                        <div class="lg:col-span-1">
                            <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                                <h3 class="text-xl font-bold text-white mb-6">關鍵詞排行</h3>
                                <div id="wordList" class="space-y-3 max-h-96 overflow-y-auto">
                                    <!-- 動態生成的排行榜內容 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 詳細資料表格 -->
                    <div id="tableSection" class="mt-8 rounded-lg bg-gray-800/50 p-6 shadow-lg" style="display: none;">
                        <h3 class="text-xl font-bold text-white mb-6">詳細資料</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-gray-300">
                                <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left">排名</th>
                                        <th class="px-6 py-3 text-left">關鍵詞</th>
                                        <th class="px-6 py-3 text-right">出現次數</th>
                                        <th class="px-6 py-3 text-right">總觀看數</th>
                                        <th class="px-6 py-3 text-right">平均觀看數</th>
                                        <th class="px-6 py-3 text-right">佔比</th>
                                    </tr>
                                </thead>
                                <tbody id="wordTableBody" class="divide-y divide-gray-700">
                                    <!-- 動態生成的表格內容 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 相關影片 Modal -->
                    <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
                        <div class="bg-gray-800 rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-4">
                                <h3 id="modalTitle" class="text-xl font-bold text-white">包含關鍵詞的影片</h3>
                                <button id="closeModal" class="text-gray-400 hover:text-white">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>
                            <div id="modalContent" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- 動態生成的影片列表 -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // 全域變數
        let allVideos = [];
        let wordData = [];
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdQjqkel8skf2fHM72cG9-BNsFQ15hpeVd0Me3LesvuxB210eHGTTyU28omHxvnZA1ZQ/exec';

        // 停用詞列表
        const STOP_WORDS = {
            chinese: ['的', '是', '在', '有', '和', '就', '不', '人', '都', '一', '了', '我', '你', '他', '她', '它', '這', '那', '也', '還', '要', '會', '可', '能', '很', '更', '最', '又', '已', '被', '將', '把', '讓', '給', '對', '從', '到', '為', '與', '及', '或', '但', '而', '且', '如', '若', '則', '所', '其', '此', '該', '以', '用', '做', '成', '下', '上', '中', '內', '外', '前', '後', '左', '右', '大', '小', '多', '少', '新', '舊', '好', '壞', '高', '低', '長', '短', '快', '慢', '早', '晚', '今', '明', '昨', '年', '月', '日', '時', '分', '秒'],
            english: ['the', 'is', 'at', 'which', 'on', 'and', 'or', 'but', 'in', 'with', 'to', 'for', 'of', 'as', 'by', 'that', 'this', 'it', 'be', 'are', 'was', 'were', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'shall', 'a', 'an', 'some', 'any', 'all', 'no', 'not', 'very', 'so', 'too', 'more', 'most', 'much', 'many', 'few', 'little', 'less', 'least', 'only', 'just', 'even', 'also', 'still', 'yet', 'already', 'always', 'never', 'often', 'sometimes', 'usually', 'here', 'there', 'where', 'when', 'why', 'how', 'what', 'who', 'whom', 'whose', 'which', 'if', 'then', 'than', 'like', 'about', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'up', 'down', 'out', 'off', 'over', 'under', 'again', 'further', 'once', 'now', 'new', 'old', 'first', 'last', 'long', 'short', 'high', 'low', 'big', 'small', 'large', 'great', 'good', 'bad', 'right', 'wrong', 'true', 'false', 'same', 'different', 'other', 'another', 'next', 'previous', 'each', 'every', 'both', 'either', 'neither', 'get', 'got', 'getting', 'go', 'going', 'went', 'gone', 'come', 'coming', 'came', 'see', 'seeing', 'saw', 'seen', 'know', 'knowing', 'knew', 'known', 'think', 'thinking', 'thought', 'say', 'saying', 'said', 'tell', 'telling', 'told', 'take', 'taking', 'took', 'taken', 'give', 'giving', 'gave', 'given', 'make', 'making', 'made', 'find', 'finding', 'found', 'look', 'looking', 'looked', 'use', 'using', 'used', 'work', 'working', 'worked', 'try', 'trying', 'tried', 'ask', 'asking', 'asked', 'need', 'needing', 'needed', 'want', 'wanting', 'wanted', 'put', 'putting', 'turn', 'turning', 'turned', 'call', 'calling', 'called', 'show', 'showing', 'showed', 'shown', 'move', 'moving', 'moved', 'live', 'living', 'lived', 'play', 'playing', 'played']
        };

        // 格式化數字顯示
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // 檢查是否為停用詞
        function isStopWord(word) {
            const lowerWord = word.toLowerCase();
            return STOP_WORDS.chinese.includes(word) || STOP_WORDS.english.includes(lowerWord);
        }

        // 智能分詞（簡化版本）
        function segmentText(text) {
            const minWordLength = parseInt(document.getElementById('minWordLength').value);

            // 移除特殊字符和數字
            text = text.replace(/[^\u4e00-\u9fa5a-zA-Z\s]/g, ' ');

            const segments = [];

            // 英文詞彙提取
            const englishWords = text.match(/[a-zA-Z]+/g) || [];
            englishWords.forEach(word => {
                if (word.length >= minWordLength && !isStopWord(word)) {
                    segments.push(word.toLowerCase());
                }
            });

            // 中文詞彙提取（基於字符組合）
            const chineseText = text.replace(/[a-zA-Z\s]/g, '');
            for (let i = 0; i < chineseText.length - minWordLength + 1; i++) {
                for (let len = minWordLength; len <= Math.min(6, chineseText.length - i); len++) {
                    const segment = chineseText.substr(i, len);
                    if (!isStopWord(segment) && segment.length >= minWordLength) {
                        segments.push(segment);
                    }
                }
            }

            return segments;
        }

        // 載入影片資料
        async function loadVideoData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const dataCount = document.getElementById('dataCount');

            loadingIndicator.style.display = 'flex';

            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getData`);
                const result = await response.json();

                if (result.success) {
                    allVideos = result.data;
                    dataCount.textContent = `總共 ${allVideos.length} 筆資料`;
                    generateWordCloud();
                    loadFilterOptions();
                } else {
                    throw new Error(result.error || '載入資料失敗');
                }
            } catch (error) {
                console.error('載入資料失敗:', error);
                dataCount.textContent = '載入失敗';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // 載入篩選選項
        function loadFilterOptions() {
            const regionSelect = document.getElementById('regionFilter');
            const typeSelect = document.getElementById('typeFilter');

            // 清空現有選項
            regionSelect.innerHTML = '<option value="">全部地區</option>';
            typeSelect.innerHTML = '<option value="">全部類型</option>';

            // 提取唯一的地區和類型
            const regions = [...new Set(allVideos.map(video => video.region).filter(Boolean))];
            const types = [...new Set(allVideos.map(video => video.type).filter(Boolean))];

            // 加入地區選項
            regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });

            // 加入類型選項
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }

        // 生成文字雲
        function generateWordCloud() {
            const timeRange = document.getElementById('timeRange').value;
            const regionFilter = document.getElementById('regionFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            // 篩選影片資料
            let filteredVideos = allVideos.filter(video => {
                // 時間篩選
                if (timeRange !== 'all') {
                    const days = parseInt(timeRange);
                    const videoDate = new Date(video.publishedAt);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - days);
                    if (videoDate < cutoffDate) return false;
                }

                // 地區篩選
                if (regionFilter && video.region !== regionFilter) return false;

                // 類型篩選
                if (typeFilter && video.type !== typeFilter) return false;

                return true;
            });

            // 生成詞頻統計
            const wordMap = new Map();

            filteredVideos.forEach(video => {
                if (video.title) {
                    const words = segmentText(video.title);
                    words.forEach(word => {
                        if (wordMap.has(word)) {
                            const existing = wordMap.get(word);
                            wordMap.set(word, {
                                ...existing,
                                count: existing.count + 1,
                                totalViews: existing.totalViews + (parseInt(video.viewCount) || 0),
                                videos: [...existing.videos, video]
                            });
                        } else {
                            wordMap.set(word, {
                                word: word,
                                count: 1,
                                totalViews: parseInt(video.viewCount) || 0,
                                videos: [video]
                            });
                        }
                    });
                }
            });

            // 轉換為陣列並排序
            const sortBy = document.getElementById('sortBy').value;
            const maxWords = parseInt(document.getElementById('maxWords').value);

            wordData = Array.from(wordMap.values())
                .sort((a, b) => {
                    if (sortBy === 'frequency') {
                        return b.count - a.count;
                    } else {
                        return b.totalViews - a.totalViews;
                    }
                })
                .slice(0, maxWords);

            updateDisplay();
        }

        // 更新顯示
        function updateDisplay() {
            updateStats();
            updateWordCloud();
            updateList();
            updateTable();

            // 顯示各個區塊
            document.getElementById('statsSection').style.display = 'grid';
            document.getElementById('wordCloudSection').style.display = 'grid';
            document.getElementById('tableSection').style.display = 'block';
        }

        // 更新統計概要
        function updateStats() {
            const totalWords = wordData.length;
            const totalFrequency = wordData.reduce((sum, item) => sum + item.count, 0);
            const totalViews = wordData.reduce((sum, item) => sum + item.totalViews, 0);
            const avgFrequency = totalWords > 0 ? Math.round(totalFrequency / totalWords) : 0;

            document.getElementById('totalWords').textContent = formatNumber(totalWords);
            document.getElementById('totalFrequency').textContent = formatNumber(totalFrequency);
            document.getElementById('totalViews').textContent = formatNumber(totalViews);
            document.getElementById('avgFrequency').textContent = formatNumber(avgFrequency);
        }

        // 更新文字雲
        function updateWordCloud() {
            const container = document.getElementById('wordCloud');
            container.innerHTML = '';

            if (wordData.length === 0) {
                container.innerHTML = '<p class="text-gray-400">沒有找到符合條件的關鍵詞</p>';
                return;
            }

            const maxCount = Math.max(...wordData.map(item => item.count));
            const maxViews = Math.max(...wordData.map(item => item.totalViews));

            wordData.forEach(item => {
                const fontSize = Math.max(12, (item.count / maxCount) * 48);
                const opacity = Math.max(0.4, item.totalViews / maxViews);
                const rotation = (Math.random() - 0.5) * 60; // -30° to +30°

                const wordElement = document.createElement('span');
                wordElement.className = 'word-item';
                wordElement.textContent = item.word;
                wordElement.style.fontSize = `${fontSize}px`;
                wordElement.style.opacity = opacity;
                wordElement.style.color = `hsl(${Math.random() * 360}, 70%, 60%)`;
                wordElement.style.transform = `rotate(${rotation}deg)`;
                wordElement.style.fontWeight = item.count > maxCount * 0.5 ? 'bold' : 'normal';

                wordElement.addEventListener('click', () => showRelatedVideos(item));

                container.appendChild(wordElement);
            });
        }

        // 更新排行榜列表
        function updateList() {
            const listContainer = document.getElementById('wordList');
            listContainer.innerHTML = wordData.slice(0, 20).map((item, index) => `
                <div class="flex items-center justify-between p-3 rounded-lg bg-gray-700/50 hover:bg-gray-700 transition-colors cursor-pointer"
                     onclick="showRelatedVideos(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <div class="flex items-center gap-3">
                        <span class="flex items-center justify-center w-6 h-6 rounded-full bg-[var(--primary-color)] text-white text-xs font-bold">
                            ${index + 1}
                        </span>
                        <span class="text-white font-medium">${item.word}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-white">${item.count} 次</div>
                        <div class="text-xs text-gray-400">${formatNumber(item.totalViews)} 觀看</div>
                    </div>
                </div>
            `).join('');
        }

        // 更新詳細表格
        function updateTable() {
            const tableBody = document.getElementById('wordTableBody');
            const totalFrequency = wordData.reduce((sum, item) => sum + item.count, 0);

            tableBody.innerHTML = wordData.map((item, index) => {
                const avgViews = item.count > 0 ? Math.round(item.totalViews / item.count) : 0;
                const percentage = totalFrequency > 0 ? ((item.count / totalFrequency) * 100).toFixed(1) : 0;

                return `
                    <tr class="hover:bg-gray-700/50 cursor-pointer" onclick="showRelatedVideos(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                        <td class="px-6 py-4 text-white font-medium">${index + 1}</td>
                        <td class="px-6 py-4 text-white">${item.word}</td>
                        <td class="px-6 py-4 text-right text-white">${item.count}</td>
                        <td class="px-6 py-4 text-right text-white">${formatNumber(item.totalViews)}</td>
                        <td class="px-6 py-4 text-right text-white">${formatNumber(avgViews)}</td>
                        <td class="px-6 py-4 text-right text-gray-300">${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        // 顯示相關影片
        function showRelatedVideos(wordItem) {
            const modal = document.getElementById('videoModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            modalTitle.textContent = `包含「${wordItem.word}」的影片 (${wordItem.videos.length} 個)`;

            modalContent.innerHTML = wordItem.videos.slice(0, 20).map(video => `
                <div class="bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition-colors">
                    <div class="aspect-video bg-gray-600 rounded mb-3 bg-cover bg-center"
                         style="background-image: url('${video.thumbnailUrl || `https://img.youtube.com/vi/${video.videoId}/mqdefault.jpg`}');">
                    </div>
                    <h4 class="text-white font-medium text-sm mb-2 line-clamp-2">${video.title}</h4>
                    <p class="text-gray-400 text-xs mb-2">${video.channelTitle}</p>
                    <div class="flex items-center gap-4 text-xs text-gray-400">
                        <span>${formatNumber(video.viewCount)} 觀看</span>
                        <span>${video.region}</span>
                        <a href="${video.url}" target="_blank" class="text-[var(--primary-color)] hover:underline">觀看</a>
                    </div>
                </div>
            `).join('');

            modal.style.display = 'flex';
        }

        // 事件監聽器
        document.addEventListener('DOMContentLoaded', function() {
            // 載入初始資料
            loadVideoData();

            // 篩選和設定變更事件
            document.getElementById('sortBy').addEventListener('change', generateWordCloud);
            document.getElementById('maxWords').addEventListener('change', generateWordCloud);
            document.getElementById('minWordLength').addEventListener('change', generateWordCloud);
            document.getElementById('timeRange').addEventListener('change', generateWordCloud);
            document.getElementById('regionFilter').addEventListener('change', generateWordCloud);
            document.getElementById('typeFilter').addEventListener('change', generateWordCloud);

            // Modal 控制
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('videoModal').style.display = 'none';
            });

            document.getElementById('videoModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });

            // 重新整理按鈕
            document.getElementById('refreshBtn').addEventListener('click', function() {
                loadVideoData();
            });
        });

        // 全域函數（供 onclick 使用）
        window.showRelatedVideos = showRelatedVideos;
    </script>
</body>
</html>