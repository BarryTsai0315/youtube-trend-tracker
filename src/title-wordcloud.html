<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans+TC:wght@400;500;700&family=Plus+Jakarta+Sans:wght@400;500;700;800" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <title>影片標題文字雲分析</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
            --primary-color: #ea2a33;
        }
        body {
            font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .word-cloud {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 2rem;
            min-height: 400px;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-radius: 1rem;
            border: 1px solid #374151;
        }
        .word-item {
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 6px;
            user-select: none;
        }
        .word-item:hover {
            transform: scale(1.1);
            text-shadow: 0 0 10px currentColor;
            background: rgba(234, 42, 51, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
        <div class="flex h-full grow flex-col">
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-800 px-10 py-4">
                <div class="flex items-center gap-4 text-white">
                    <svg class="h-8 w-8 text-[var(--primary-color)]" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 15.65v-7.3L16.03 12M22 12c0 5.52-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2s10 4.48 10 10zM4 12c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8-8 3.58-8 8z"></path>
                    </svg>
                    <h1 class="text-xl font-bold tracking-tight">影片標題文字雲分析</h1>
                </div>

                <div class="flex items-center gap-6">
                    <!-- 導航按鈕 -->
                    <div class="flex items-center gap-2">
                        <a href="youtube-search.html" class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium hover:bg-gray-600 hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-sm mr-1">video_library</span>
                            影片搜尋
                        </a>
                        <a href="hashtag-analytics.html" class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium hover:bg-gray-600 hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-sm mr-1">analytics</span>
                            Hashtag 統計
                        </a>
                        <a href="title-wordcloud.html" class="px-4 py-2 rounded-lg bg-[var(--primary-color)] text-white font-medium hover:bg-red-700 transition-colors">
                            <span class="material-symbols-outlined text-sm mr-1">cloud</span>
                            標題文字雲
                        </a>
                    </div>

                    <!-- 資料狀態和操作 -->
                    <div class="flex items-center gap-4">
                        <span id="dataCount" class="text-sm text-gray-400">載入中...</span>
                        <button id="refreshBtn" class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-full bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white">
                            <span class="material-symbols-outlined">refresh</span>
                        </button>
                    </div>
                </div>
            </header>

            <main class="flex-1 px-4 py-8 sm:px-6 lg:px-8">
                <div class="mx-auto max-w-7xl">
                    <!-- 控制面板 -->
                    <div class="mb-8 rounded-lg bg-gray-800/50 p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold tracking-tight text-white">文字雲設定</h2>
                            <div class="flex items-center gap-4">
                                <button id="generateBtn" class="px-6 py-2 rounded-lg bg-[var(--primary-color)] text-white font-medium hover:bg-red-700 transition-colors">
                                    <span class="material-symbols-outlined text-sm mr-1">auto_fix_high</span>
                                    重新生成
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
                            <div class="flex flex-col">
                                <label class="mb-2 text-sm font-medium text-gray-300">詞彙數量</label>
                                <select id="wordCount" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="30">30 個詞彙</option>
                                    <option value="50" selected>50 個詞彙</option>
                                    <option value="100">100 個詞彙</option>
                                    <option value="200">200 個詞彙</option>
                                </select>
                            </div>

                            <div class="flex flex-col">
                                <label class="mb-2 text-sm font-medium text-gray-300">最小字數</label>
                                <select id="minLength" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="1">1 個字</option>
                                    <option value="2" selected>2 個字</option>
                                    <option value="3">3 個字</option>
                                    <option value="4">4 個字</option>
                                </select>
                            </div>

                            <div class="flex flex-col">
                                <label class="mb-2 text-sm font-medium text-gray-300">排序方式</label>
                                <select id="sortBy" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="frequency">按出現頻率</option>
                                    <option value="views">按總觀看數</option>
                                    <option value="avgViews">按平均觀看數</option>
                                </select>
                            </div>

                            <div class="flex flex-col">
                                <label class="mb-2 text-sm font-medium text-gray-300">時間範圍</label>
                                <select id="timeRange" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="all">全部時間</option>
                                    <option value="7">最近 7 天</option>
                                    <option value="30">最近 30 天</option>
                                    <option value="90">最近 90 天</option>
                                </select>
                            </div>
                        </div>

                        <div class="mt-6 grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div class="flex flex-col">
                                <label class="mb-2 text-sm font-medium text-gray-300">地區篩選</label>
                                <select id="regionFilter" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="">全部地區</option>
                                </select>
                            </div>

                            <div class="flex flex-col">
                                <label class="mb-2 text-sm font-medium text-gray-300">影片類型</label>
                                <select id="typeFilter" class="rounded-md border-gray-700 bg-gray-800 text-white focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]">
                                    <option value="">全部類型</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 載入指示器 -->
                    <div id="loadingIndicator" class="flex items-center justify-center py-12">
                        <span class="material-symbols-outlined text-4xl text-gray-400 loading">cloud</span>
                        <span class="ml-2 text-gray-400">分析標題關鍵詞中...</span>
                    </div>

                    <!-- 統計概要 -->
                    <div id="statsSection" class="mb-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4" style="display: none;">
                        <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">總影片數</p>
                                    <p id="totalVideos" class="text-2xl font-bold text-white">0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">video_library</span>
                            </div>
                        </div>

                        <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">總關鍵詞數</p>
                                    <p id="totalWords" class="text-2xl font-bold text-white">0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">text_fields</span>
                            </div>
                        </div>

                        <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">最熱門關鍵詞</p>
                                    <p id="topWord" class="text-2xl font-bold text-white">-</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">star</span>
                            </div>
                        </div>

                        <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">平均標題長度</p>
                                    <p id="avgTitleLength" class="text-2xl font-bold text-white">0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">straighten</span>
                            </div>
                        </div>
                    </div>

                    <!-- 文字雲區域 -->
                    <div id="wordCloudSection" class="mb-8 rounded-lg bg-gray-800/50 p-6 shadow-lg" style="display: none;">
                        <h3 class="text-xl font-bold text-white mb-6">標題關鍵詞文字雲</h3>
                        <div id="wordCloud" class="word-cloud">
                            <!-- 動態生成的文字雲 -->
                        </div>
                        <div class="mt-4 text-center text-sm text-gray-400">
                            點擊關鍵詞可查看包含該詞的影片
                        </div>
                    </div>

                    <!-- 關鍵詞排行榜 -->
                    <div id="rankingSection" class="mb-8 grid grid-cols-1 lg:grid-cols-2 gap-8" style="display: none;">
                        <!-- 頻率排行 -->
                        <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                            <h3 class="text-xl font-bold text-white mb-6">出現頻率排行</h3>
                            <div id="frequencyRanking" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- 動態生成的排行榜 -->
                            </div>
                        </div>

                        <!-- 觀看數排行 -->
                        <div class="rounded-lg bg-gray-800/50 p-6 shadow-lg">
                            <h3 class="text-xl font-bold text-white mb-6">總觀看數排行</h3>
                            <div id="viewsRanking" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- 動態生成的排行榜 -->
                            </div>
                        </div>
                    </div>

                    <!-- 關鍵詞詳細列表 -->
                    <div id="detailSection" class="rounded-lg bg-gray-800/50 p-6 shadow-lg" style="display: none;">
                        <h3 class="text-xl font-bold text-white mb-6">關鍵詞詳細資料</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-gray-300">
                                <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left">排名</th>
                                        <th class="px-6 py-3 text-left">關鍵詞</th>
                                        <th class="px-6 py-3 text-right">出現次數</th>
                                        <th class="px-6 py-3 text-right">總觀看數</th>
                                        <th class="px-6 py-3 text-right">平均觀看數</th>
                                        <th class="px-6 py-3 text-right">頻率佔比</th>
                                        <th class="px-6 py-3 text-center">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="detailTableBody" class="divide-y divide-gray-700">
                                    <!-- 動態生成的表格內容 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 選中關鍵詞的影片列表 -->
                    <div id="selectedWordVideos" class="mt-8 rounded-lg bg-gray-800/50 p-6 shadow-lg" style="display: none;">
                        <div class="flex items-center justify-between mb-6">
                            <h3 id="selectedWordTitle" class="text-xl font-bold text-white">包含 "" 的影片</h3>
                            <button id="closeSelectedBtn" class="text-gray-400 hover:text-white">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                        <div id="selectedVideosList" class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                            <!-- 動態生成的影片列表 -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // 全域變數
        let allVideos = [];
        let wordData = [];
        let currentSelectedWord = null;
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxa4QrXlLKdr9EP9PsskvnLhVwjSgHx8u3sRP6FmSoKGD-NbEHh6wMpQ6rodyAD2GhKhQ/exec';

        // 常見的停用詞（中英文）
        const STOP_WORDS = new Set([
            '的', '是', '在', '了', '和', '有', '我', '你', '他', '她', '它', '們', '都', '不', '也', '就', '可以', '這', '那', '但', '如果', '因為', '所以', '而且', '或者', '還是', '已經', '沒有', '只要', '雖然', '然後', '現在', '時候', '地方', '什麼', '怎麼', '為什麼', '多少', '哪裡', '什麼', '怎樣',
            'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'this', 'that', 'these', 'those', 'a', 'an', 'as', 'if', 'when', 'where', 'why', 'how', 'what', 'who', 'which', 'whose', 'whom'
        ]);

        // 格式化數字顯示
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // 載入影片資料
        async function loadVideoData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const dataCount = document.getElementById('dataCount');

            loadingIndicator.style.display = 'flex';

            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getData`);
                const result = await response.json();

                if (result.success) {
                    allVideos = result.data;
                    dataCount.textContent = `總共 ${allVideos.length} 筆資料`;
                    generateWordCloud();
                    loadFilterOptions();
                } else {
                    throw new Error(result.error || '載入資料失敗');
                }
            } catch (error) {
                console.error('載入資料失敗:', error);
                dataCount.textContent = '載入失敗';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // 載入篩選選項
        function loadFilterOptions() {
            const regionSelect = document.getElementById('regionFilter');
            const typeSelect = document.getElementById('typeFilter');

            // 清空現有選項
            regionSelect.innerHTML = '<option value="">全部地區</option>';
            typeSelect.innerHTML = '<option value="">全部類型</option>';

            // 提取唯一的地區和類型
            const regions = [...new Set(allVideos.map(video => video.region).filter(Boolean))];
            const types = [...new Set(allVideos.map(video => video.type).filter(Boolean))];

            // 加入地區選項
            regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });

            // 加入類型選項
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }

        // 分詞函數（簡單版本）
        function tokenizeTitle(title) {
            if (!title) return [];

            // 移除標點符號和特殊字符
            const cleanTitle = title.replace(/[^\w\s\u4e00-\u9fff]/g, ' ');

            // 分割成詞彙
            const words = [];

            // 英文詞彙（按空格分割）
            const englishWords = cleanTitle.match(/[a-zA-Z]+/g) || [];
            words.push(...englishWords);

            // 中文詞彙（每1-4個字作為一個詞）
            const chineseText = cleanTitle.replace(/[a-zA-Z\s]/g, '');
            const minLength = parseInt(document.getElementById('minLength').value);

            for (let i = 0; i < chineseText.length; i++) {
                for (let len = minLength; len <= Math.min(4, chineseText.length - i); len++) {
                    const word = chineseText.substr(i, len);
                    if (word.length >= minLength) {
                        words.push(word);
                    }
                }
            }

            // 過濾停用詞和短詞
            return words.filter(word =>
                word.length >= minLength &&
                !STOP_WORDS.has(word.toLowerCase()) &&
                word.trim() !== ''
            );
        }

        // 生成文字雲資料
        function generateWordCloud() {
            const timeRange = document.getElementById('timeRange').value;
            const regionFilter = document.getElementById('regionFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const wordCount = parseInt(document.getElementById('wordCount').value);
            const sortBy = document.getElementById('sortBy').value;

            // 篩選影片資料
            let filteredVideos = allVideos.filter(video => {
                // 時間篩選
                if (timeRange !== 'all') {
                    const days = parseInt(timeRange);
                    const videoDate = new Date(video.publishedAt);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - days);
                    if (videoDate < cutoffDate) return false;
                }

                // 地區篩選
                if (regionFilter && video.region !== regionFilter) return false;

                // 類型篩選
                if (typeFilter && video.type !== typeFilter) return false;

                return true;
            });

            // 提取關鍵詞
            const wordMap = new Map();

            filteredVideos.forEach(video => {
                const words = tokenizeTitle(video.title);
                words.forEach(word => {
                    if (wordMap.has(word)) {
                        const existing = wordMap.get(word);
                        wordMap.set(word, {
                            ...existing,
                            count: existing.count + 1,
                            totalViews: existing.totalViews + (video.viewCount || 0),
                            videos: [...existing.videos, video]
                        });
                    } else {
                        wordMap.set(word, {
                            word: word,
                            count: 1,
                            totalViews: video.viewCount || 0,
                            videos: [video]
                        });
                    }
                });
            });

            // 轉換為陣列並排序
            wordData = Array.from(wordMap.values())
                .filter(item => item.count >= 2) // 至少出現2次
                .sort((a, b) => {
                    if (sortBy === 'frequency') {
                        return b.count - a.count;
                    } else if (sortBy === 'views') {
                        return b.totalViews - a.totalViews;
                    } else { // avgViews
                        return (b.totalViews / b.count) - (a.totalViews / a.count);
                    }
                })
                .slice(0, wordCount);

            updateDisplay(filteredVideos);
        }

        // 更新顯示
        function updateDisplay(filteredVideos) {
            updateStats(filteredVideos);
            updateWordCloud();
            updateRankings();
            updateDetailTable();

            // 顯示各個區塊
            document.getElementById('statsSection').style.display = 'grid';
            document.getElementById('wordCloudSection').style.display = 'block';
            document.getElementById('rankingSection').style.display = 'grid';
            document.getElementById('detailSection').style.display = 'block';
        }

        // 更新統計概要
        function updateStats(filteredVideos) {
            const totalVideos = filteredVideos.length;
            const totalWords = wordData.length;
            const topWord = wordData.length > 0 ? wordData[0].word : '-';
            const avgTitleLength = filteredVideos.length > 0
                ? Math.round(filteredVideos.reduce((sum, video) => sum + (video.title?.length || 0), 0) / filteredVideos.length)
                : 0;

            document.getElementById('totalVideos').textContent = formatNumber(totalVideos);
            document.getElementById('totalWords').textContent = formatNumber(totalWords);
            document.getElementById('topWord').textContent = topWord;
            document.getElementById('avgTitleLength').textContent = avgTitleLength + ' 字';
        }

        // 更新文字雲
        function updateWordCloud() {
            const wordCloudContainer = document.getElementById('wordCloud');

            if (wordData.length === 0) {
                wordCloudContainer.innerHTML = '<div class="text-gray-400 text-center">沒有找到關鍵詞資料</div>';
                return;
            }

            const maxCount = Math.max(...wordData.map(item => item.count));
            const minSize = 14;
            const maxSize = 48;

            const colors = [
                '#ea2a33', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6',
                '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1',
                '#14b8a6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'
            ];

            wordCloudContainer.innerHTML = wordData.map((item, index) => {
                const fontSize = minSize + (maxSize - minSize) * (item.count / maxCount);
                const color = colors[index % colors.length];
                const rotation = Math.random() > 0.7 ? (Math.random() > 0.5 ? 15 : -15) : 0;

                return `
                    <span
                        class="word-item"
                        style="font-size: ${fontSize}px; color: ${color}; transform: rotate(${rotation}deg);"
                        onclick="showWordVideos('${item.word}')"
                        title="${item.word}: ${item.count} 次, ${formatNumber(item.totalViews)} 觀看"
                    >
                        ${item.word}
                    </span>
                `;
            }).join('');
        }

        // 更新排行榜
        function updateRankings() {
            // 頻率排行
            const frequencyContainer = document.getElementById('frequencyRanking');
            const sortedByFreq = [...wordData].sort((a, b) => b.count - a.count);

            frequencyContainer.innerHTML = sortedByFreq.slice(0, 15).map((item, index) => `
                <div class="flex items-center justify-between p-3 rounded-lg bg-gray-700/50 hover:bg-gray-700 transition-colors cursor-pointer"
                     onclick="showWordVideos('${item.word}')">
                    <div class="flex items-center gap-3">
                        <span class="flex items-center justify-center w-6 h-6 rounded-full bg-[var(--primary-color)] text-white text-xs font-bold">
                            ${index + 1}
                        </span>
                        <span class="text-white font-medium">${item.word}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-white">${item.count} 次</div>
                        <div class="text-xs text-gray-400">${formatNumber(item.totalViews)} 觀看</div>
                    </div>
                </div>
            `).join('');

            // 觀看數排行
            const viewsContainer = document.getElementById('viewsRanking');
            const sortedByViews = [...wordData].sort((a, b) => b.totalViews - a.totalViews);

            viewsContainer.innerHTML = sortedByViews.slice(0, 15).map((item, index) => `
                <div class="flex items-center justify-between p-3 rounded-lg bg-gray-700/50 hover:bg-gray-700 transition-colors cursor-pointer"
                     onclick="showWordVideos('${item.word}')">
                    <div class="flex items-center gap-3">
                        <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-bold">
                            ${index + 1}
                        </span>
                        <span class="text-white font-medium">${item.word}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-white">${formatNumber(item.totalViews)}</div>
                        <div class="text-xs text-gray-400">${item.count} 次使用</div>
                    </div>
                </div>
            `).join('');
        }

        // 更新詳細表格
        function updateDetailTable() {
            const tableBody = document.getElementById('detailTableBody');
            const totalCount = wordData.reduce((sum, item) => sum + item.count, 0);

            tableBody.innerHTML = wordData.map((item, index) => {
                const avgViews = item.count > 0 ? Math.round(item.totalViews / item.count) : 0;
                const percentage = totalCount > 0 ? ((item.count / totalCount) * 100).toFixed(1) : 0;

                return `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-4 text-white font-medium">${index + 1}</td>
                        <td class="px-6 py-4 text-white font-medium">${item.word}</td>
                        <td class="px-6 py-4 text-right text-white">${item.count}</td>
                        <td class="px-6 py-4 text-right text-white">${formatNumber(item.totalViews)}</td>
                        <td class="px-6 py-4 text-right text-white">${formatNumber(avgViews)}</td>
                        <td class="px-6 py-4 text-right text-gray-300">${percentage}%</td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="showWordVideos('${item.word}')"
                                    class="text-[var(--primary-color)] hover:text-red-400 font-medium">
                                查看影片
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 顯示包含特定關鍵詞的影片
        function showWordVideos(word) {
            currentSelectedWord = word;
            const wordItem = wordData.find(item => item.word === word);

            if (!wordItem) return;

            const section = document.getElementById('selectedWordVideos');
            const title = document.getElementById('selectedWordTitle');
            const videosList = document.getElementById('selectedVideosList');

            title.textContent = `包含 "${word}" 的影片 (${wordItem.videos.length} 個)`;

            videosList.innerHTML = wordItem.videos.slice(0, 12).map(video => `
                <div class="rounded-lg bg-gray-700/50 p-4 hover:bg-gray-700 transition-colors">
                    <div class="aspect-video bg-gray-600 rounded mb-3 overflow-hidden">
                        <img src="https://img.youtube.com/vi/${video.videoId}/mqdefault.jpg"
                             alt="${video.title}"
                             class="w-full h-full object-cover"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\"><rect width=\"100\" height=\"100\" fill=\"%23374151\"/></svg>'">
                    </div>
                    <h4 class="text-sm font-medium text-white mb-2 line-clamp-2">${video.title}</h4>
                    <div class="flex items-center justify-between text-xs text-gray-400">
                        <span>${formatNumber(video.viewCount)} 觀看</span>
                        <a href="${video.url}" target="_blank" class="text-[var(--primary-color)] hover:text-red-400">
                            觀看
                        </a>
                    </div>
                </div>
            `).join('');

            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // 事件監聽器
        document.addEventListener('DOMContentLoaded', function() {
            // 載入初始資料
            loadVideoData();

            // 設定變更事件
            document.getElementById('wordCount').addEventListener('change', generateWordCloud);
            document.getElementById('minLength').addEventListener('change', generateWordCloud);
            document.getElementById('sortBy').addEventListener('change', generateWordCloud);
            document.getElementById('timeRange').addEventListener('change', generateWordCloud);
            document.getElementById('regionFilter').addEventListener('change', generateWordCloud);
            document.getElementById('typeFilter').addEventListener('change', generateWordCloud);

            // 重新生成按鈕
            document.getElementById('generateBtn').addEventListener('click', generateWordCloud);

            // 重新整理按鈕
            document.getElementById('refreshBtn').addEventListener('click', function() {
                loadVideoData();
            });

            // 關閉選中詞彙的影片列表
            document.getElementById('closeSelectedBtn').addEventListener('click', function() {
                document.getElementById('selectedWordVideos').style.display = 'none';
            });
        });
    </script>
</body>
</html>